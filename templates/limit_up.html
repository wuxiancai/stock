<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊâìÊùøÁ≠õÈÄâÁªìÊûú - ËÇ°Á•®ÈÄâËÇ°Á≥ªÁªü</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        body {
            font-size: 12px;
        }
        .table {
            font-size: 11px;
        }
        .table td, .table th {
            text-align: center;
        }
        .table th {
            font-size: 11px;
            font-weight: 600;
        }
        .table td {
            font-size: 11px;
        }
        .td-positive {
            color: #dc3545;
            font-weight: bold;
        }
        .td-negative {
            color: #28a745;
            font-weight: bold;
        }
        .stock-row:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-item label {
            font-weight: 500;
            margin: 0;
            white-space: nowrap;
        }
        .filter-item input {
            width: 60px;
            font-size: 11px;
        }
        .filter-item select {
            width: 100px;
            font-size: 11px;
        }
        .hidden-column {
            display: none;
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .sortable-header:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sort-icon {
            margin-left: 5px;
            opacity: 0.5;
        }
        .sort-icon.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>
                ËÇ°Á•®ÈÄâËÇ°Á≥ªÁªü
            </a>
            <div class="navbar-nav ms-auto">
                <a class="btn btn-outline-light btn-sm" href="/">
                    <i class="fas fa-home"></i> ËøîÂõûÈ¶ñÈ°µ
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            <span id="pageTitle">ÊâìÊùøÁ≠õÈÄâÁªìÊûúÔºàÊ∂®ÂÅú‰∏îÊàê‰∫§È¢ù>10‰∫øÔºâ</span>
                        </h5>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> Âà∑Êñ∞Êï∞ÊçÆ
                            </button>
                            <span class="badge bg-info ms-2" id="totalCount">Âä†ËΩΩ‰∏≠...</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Á≠õÈÄâÊù°‰ª∂Âå∫Âüü -->
                        <div class="filter-section">
                            <!-- Êàê‰∫§È¢ùÈó®ÊßõÂø´ÈÄüÈÄâÊã© -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">üí∞ Êàê‰∫§È¢ùÈó®ÊßõÂø´ÈÄüÈÄâÊã©:</label>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="amountThreshold" id="threshold30" value="30">
                                    <label class="btn btn-outline-primary" for="threshold30">‚â•30‰∫ø</label>
                                    
                                    <input type="radio" class="btn-check" name="amountThreshold" id="threshold20" value="20">
                                    <label class="btn btn-outline-primary" for="threshold20">‚â•20‰∫ø</label>
                                    
                                    <input type="radio" class="btn-check" name="amountThreshold" id="threshold10" value="10" checked>
                                    <label class="btn btn-outline-primary" for="threshold10">‚â•10‰∫ø</label>
                                    
                                    <input type="radio" class="btn-check" name="amountThreshold" id="threshold5" value="5">
                                    <label class="btn btn-outline-primary" for="threshold5">‚â•5‰∫ø</label>
                                    
                                    <input type="radio" class="btn-check" name="amountThreshold" id="threshold1" value="1">
                                    <label class="btn btn-outline-primary" for="threshold1">‚â•1‰∫ø</label>
                                    
                                    <input type="radio" class="btn-check" name="amountThreshold" id="threshold0" value="0">
                                    <label class="btn btn-outline-primary" for="threshold0">‰∏çÈôêÂà∂</label>
                                </div>
                                <button class="btn btn-success btn-sm ms-3" onclick="applyAmountThreshold()">
                                    <i class="fas fa-search"></i> Â∫îÁî®Èó®Êßõ
                                </button>
                            </div>
                            
                            <div class="filter-row">
                                <div class="filter-item">
                                    <label>ÈáèÊØî:</label>
                                    <input type="number" id="volumeRatioMin" class="form-control" placeholder="Â∞è" step="0.1">
                                    <span>-</span>
                                    <input type="number" id="volumeRatioMax" class="form-control" placeholder="Â§ß" step="0.1">
                                </div>
                                <div class="filter-item">
                                    <label>Êç¢ÊâãÁéá(%):</label>
                                    <input type="number" id="turnoverRateMin" class="form-control" placeholder="Â∞è" step="0.1">
                                    <span>-</span>
                                    <input type="number" id="turnoverRateMax" class="form-control" placeholder="Â§ß" step="0.1">
                                </div>
                                <div class="filter-item">
                                    <label>ÂáÄÊµÅÂÖ•È¢ù(‰∏á):</label>
                                    <input type="number" id="netMfAmountMin" class="form-control" placeholder="Â∞è">
                                    <span>-</span>
                                    <input type="number" id="netMfAmountMax" class="form-control" placeholder="Â§ß">
                                </div>
                                <div class="filter-item">
                                    <label>Êàê‰∫§È¢ù(‰∫ø):</label>
                                    <input type="number" id="amountMin" class="form-control" placeholder="Â∞è" step="0.1">
                                    <span>-</span>
                                    <input type="number" id="amountMax" class="form-control" placeholder="Â§ß" step="0.1">
                                </div>
                                <div class="filter-item">
                                    <label>ËÇ°Á•®‰ª£Á†Å:</label>
                                    <input type="text" id="stockCode" class="form-control" placeholder="Â¶Ç:300222" style="width: 120px;">
                                </div>
                                <div class="filter-item">
                                    <button class="btn btn-primary btn-sm" onclick="applyFilters()">
                                        <i class="fas fa-filter"></i> Â∫îÁî®Á≠õÈÄâ
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="clearFilters()">
                                        <i class="fas fa-times"></i> Ê∏ÖÈô§
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="loadingIndicator" class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Âä†ËΩΩ‰∏≠...</span>
                            </div>
                            <p class="mt-2">Ê≠£Âú®Âä†ËΩΩÊâìÊùøÊï∞ÊçÆ...</p>
                        </div>
                        
                        <div id="stockTable" class="table-responsive" style="display: none;">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="sortable-header" onclick="sortTable('ts_code')">
                                            ËÇ°Á•®‰ª£Á†Å
                                            <i class="fas fa-sort sort-icon" id="sort-ts_code"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('name')">
                                            ËÇ°Á•®ÂêçÁß∞
                                            <i class="fas fa-sort sort-icon" id="sort-name"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('industry')">
                                            Ë°å‰∏ö
                                            <i class="fas fa-sort sort-icon" id="sort-industry"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('area')">
                                            Âú∞Âüü
                                            <i class="fas fa-sort sort-icon" id="sort-area"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('close')">
                                            ÊúÄÊñ∞‰ª∑
                                            <i class="fas fa-sort sort-icon" id="sort-close"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('pct_chg')">
                                            Ê∂®Ë∑åÂπÖ
                                            <i class="fas fa-sort sort-icon" id="sort-pct_chg"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('td_sequential')">
                                            ‰πùËΩ¨
                                            <i class="fas fa-sort sort-icon" id="sort-td_sequential"></i>
                                        </th>
                                        <th class="hidden-column sortable-header" onclick="sortTable('change')">
                                            Ê∂®Ë∑åÈ¢ù
                                            <i class="fas fa-sort sort-icon" id="sort-change"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('turnover_rate')">
                                            Êç¢ÊâãÁéá
                                            <i class="fas fa-sort sort-icon" id="sort-turnover_rate"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('volume_ratio')">
                                            ÈáèÊØî
                                            <i class="fas fa-sort sort-icon" id="sort-volume_ratio"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('pe')">
                                            Â∏ÇÁõàÁéá
                                            <i class="fas fa-sort sort-icon" id="sort-pe"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('pb')">
                                            Â∏ÇÂáÄÁéá
                                            <i class="fas fa-sort sort-icon" id="sort-pb"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('total_mv')">
                                            ÊÄªÂ∏ÇÂÄº
                                            <i class="fas fa-sort sort-icon" id="sort-total_mv"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('net_mf_amount')">
                                            ÂáÄÊµÅÂÖ•È¢ù
                                            <i class="fas fa-sort sort-icon" id="sort-net_mf_amount"></i>
                                        </th>
                                        <th class="hidden-column sortable-header" onclick="sortTable('vol')">
                                            Êàê‰∫§Èáè(‰∏áÊâã)
                                            <i class="fas fa-sort sort-icon" id="sort-vol"></i>
                                        </th>
                                        <th class="sortable-header" onclick="sortTable('amount')">
                                            Êàê‰∫§È¢ù
                                            <i class="fas fa-sort sort-icon" id="sort-amount"></i>
                                        </th>
                                        <th>Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody id="stockTableBody">
                                    <!-- Êï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="noDataMessage" class="text-center py-4" style="display: none;">
                            <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">ÊöÇÊó†Á¨¶ÂêàÊù°‰ª∂ÁöÑËÇ°Á•®</h5>
                            <p class="text-muted">ÂΩìÂâçÊ≤°ÊúâÊâæÂà∞Ê∂®ÂÅú‰∏îÊàê‰∫§È¢ùÂ§ß‰∫é10‰∫øÁöÑËÇ°Á•®</p>
                        </div>
                        
                        <div id="errorMessage" class="alert alert-danger" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="errorText"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast ÈÄöÁü• -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">Á≥ªÁªüÈÄöÁü•</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- ÈÄöÁü•ÂÜÖÂÆπ -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ÂÖ®Â±ÄÂèòÈáèÂ≠òÂÇ®ÂéüÂßãÊï∞ÊçÆ
        let originalStockData = [];
        let currentStockData = []; // ÂΩìÂâçÊòæÁ§∫ÁöÑÊï∞ÊçÆÔºàÂèØËÉΩÁªèËøáÁ≠õÈÄâÔºâ
        let currentSortField = null;
        let currentSortOrder = 'asc'; // 'asc' Êàñ 'desc'
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÊï∞ÊçÆ
        document.addEventListener('DOMContentLoaded', function() {
            loadLimitUpData();
        });

        function loadLimitUpData() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('stockTable').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            // Ëé∑ÂèñÂΩìÂâçÈÄâÊã©ÁöÑÊàê‰∫§È¢ùÈó®Êßõ
            const selectedThreshold = document.querySelector('input[name="amountThreshold"]:checked')?.value || '10';
            
            fetch(`/api/limit_up_stocks?amount_threshold=${selectedThreshold}`)
                .then(response => response.json())
                .then(data => {
                    // ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
                    document.getElementById('loadingIndicator').style.display = 'none';

                    // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
                    const thresholdText = data.amount_threshold > 0 ? `${data.amount_threshold}‰∫ø` : '‰∏çÈôêÂà∂';
                    document.getElementById('pageTitle').textContent = `ÊâìÊùøÁ≠õÈÄâÁªìÊûúÔºàÊ∂®ÂÅú‰∏îÊàê‰∫§È¢ù>${thresholdText}Ôºâ`;
                    
                    if (data.stocks && data.stocks.length > 0) {
                        originalStockData = data.stocks; // ‰øùÂ≠òÂéüÂßãÊï∞ÊçÆ
                        displayStockData(data.stocks);
                        document.getElementById('totalCount').textContent = `ÂÖ± ${data.total} Âè™ËÇ°Á•®`;
                    } else {
                        document.getElementById('noDataMessage').style.display = 'block';
                        document.getElementById('totalCount').textContent = '0 Âè™ËÇ°Á•®';
                        
                        // Ê≥®ÊÑèÔºöÁªüËÆ°‰ø°ÊÅØÂ∑≤Âú®ÂìçÂ∫îÊï∞ÊçÆ‰∏≠Ôºå‰ΩÜÊ≠§È°µÈù¢‰∏çÊòæÁ§∫Ëøô‰∫õÂÖÉÁ¥†
                        
                        // Êõ¥Êñ∞Êó†Êï∞ÊçÆÊèêÁ§∫‰∏≠ÁöÑÈó®Êßõ‰ø°ÊÅØ
                        const noDataText = document.querySelector('#noDataMessage p');
                        if (noDataText) {
                            noDataText.textContent = `ÂΩìÂâçÊ≤°ÊúâÊâæÂà∞Ê∂®ÂÅú‰∏îÊàê‰∫§È¢ùÂ§ß‰∫é${thresholdText}ÁöÑËÇ°Á•®`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('errorText').textContent = 'Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•Ôºö' + error.message;
                    document.getElementById('totalCount').textContent = 'Âä†ËΩΩÂ§±Ë¥•';
                });
        }

        function displayStockData(stocks) {
            currentStockData = stocks; // Êõ¥Êñ∞ÂΩìÂâçÊòæÁ§∫ÁöÑÊï∞ÊçÆ
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';

            stocks.forEach(stock => {
                const row = document.createElement('tr');
                row.className = 'stock-row';
                row.onclick = () => viewStockDetail(stock.ts_code);

                // Ê†ºÂºèÂåñ‰πùËΩ¨Â∫èÂàóÊòæÁ§∫
                let tdSequentialDisplay = '';
                if (stock.td_sequential > 0) {
                    tdSequentialDisplay = `<span class="td-positive">${stock.td_sequential}</span>`;
                } else if (stock.td_sequential < 0) {
                    tdSequentialDisplay = `<span class="td-negative">${Math.abs(stock.td_sequential)}</span>`;
                } else {
                    tdSequentialDisplay = '-';
                }

                // Ê†ºÂºèÂåñÊ∂®Ë∑åÂπÖÈ¢úËâ≤
                let pctChgClass = '';
                if (stock.pct_chg > 0) {
                    pctChgClass = 'text-danger';
                } else if (stock.pct_chg < 0) {
                    pctChgClass = 'text-success';
                }

                row.innerHTML = `
                    <td><strong>${stock.ts_code}</strong></td>
                    <td>${stock.name || '-'}</td>
                    <td>${stock.industry || '-'}</td>
                    <td>${stock.area || '-'}</td>
                    <td>¬•${stock.close.toFixed(2)}</td>
                    <td class="${pctChgClass}">${stock.pct_chg > 0 ? '+' : ''}${stock.pct_chg.toFixed(2)}%</td>
                    <td>${tdSequentialDisplay}</td>
                    <td class="hidden-column ${pctChgClass}">${stock.change > 0 ? '+' : ''}${stock.change.toFixed(2)}</td>
                    <td>${stock.turnover_rate ? stock.turnover_rate.toFixed(2) + '%' : '-'}</td>
                    <td>${stock.volume_ratio ? stock.volume_ratio.toFixed(2) : '-'}</td>
                    <td>${stock.pe ? stock.pe.toFixed(2) : '-'}</td>
                    <td>${stock.pb ? stock.pb.toFixed(2) : '-'}</td>
                    <td>${stock.total_mv ? (() => {
                        const value = stock.total_mv / 10000;
                        return value >= 1 ? value.toFixed(1) + '‰∫ø' : (value * 10000).toFixed(0) + '‰∏á';
                    })() : '-'}</td>
                    <td class="${stock.net_mf_amount > 0 ? 'text-danger' : stock.net_mf_amount < 0 ? 'text-success' : ''}">${stock.net_mf_amount ? (() => {
                        const value = stock.net_mf_amount / 10000;
                        return value >= 1 ? value.toFixed(2) + '‰∫ø' : (value * 10000).toFixed(0) + '‰∏á';
                    })() : '-'}</td>
                    <td class="hidden-column">${(stock.vol / 10000).toFixed(2)}</td>
                    <td>${(() => {
                        const value = stock.amount / 100000;
                        return value >= 1 ? value.toFixed(1) + '‰∫ø' : (value * 10000).toFixed(0) + '‰∏á';
                    })()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); addToFavorites('${stock.ts_code}', '${stock.name}')" title="Âä†ÂÖ•Ëá™ÈÄâËÇ°">
                                <i class="fas fa-star"></i>
                            </button>
                    </td>
                `;

                tbody.appendChild(row);
            });

            document.getElementById('stockTable').style.display = 'block';
        }

        function viewStockDetail(tsCode) {
            // Âú®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄËÇ°Á•®ËØ¶ÊÉÖÈ°µ
            window.open(`/stock/${tsCode}`, '_blank');
        }

        // Âä†ÂÖ•Ëá™ÈÄâËÇ°ÂäüËÉΩ
        async function addToFavorites(tsCode, stockName) {
            try {
                const response = await fetch('/api/favorites/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ts_code: tsCode,
                        name: stockName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`${stockName} Â∑≤Âä†ÂÖ•Ëá™ÈÄâËÇ°`, 'success');
                } else {
                    showToast(data.message || 'Âä†ÂÖ•Ëá™ÈÄâËÇ°Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Error adding to favorites:', error);
                showToast('Âä†ÂÖ•Ëá™ÈÄâËÇ°Â§±Ë¥•', 'error');
            }
        }

        function refreshData() {
            loadLimitUpData();
            showToast('Êï∞ÊçÆÂà∑Êñ∞‰∏≠...', 'info');
        }

        function showToast(message, type = 'info') {
            const toastElement = document.getElementById('notificationToast');
            const toastBody = document.getElementById('toastMessage');
            
            toastBody.textContent = message;
            
            // ËÆæÁΩÆToastÊ†∑Âºè
            toastElement.className = `toast ${type === 'success' ? 'bg-success text-white' : type === 'error' ? 'bg-danger text-white' : ''}`;
            
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }
        
        // Â∫îÁî®Á≠õÈÄâÊù°‰ª∂
        function applyFilters() {
            const volumeRatioMin = parseFloat(document.getElementById('volumeRatioMin').value) || 0;
            const volumeRatioMax = parseFloat(document.getElementById('volumeRatioMax').value) || Infinity;
            const turnoverRateMin = parseFloat(document.getElementById('turnoverRateMin').value) || 0;
            const turnoverRateMax = parseFloat(document.getElementById('turnoverRateMax').value) || Infinity;
            const netMfAmountMin = parseFloat(document.getElementById('netMfAmountMin').value) || -Infinity;
            const netMfAmountMax = parseFloat(document.getElementById('netMfAmountMax').value) || Infinity;
            const amountMin = parseFloat(document.getElementById('amountMin').value) || 0;
            const amountMax = parseFloat(document.getElementById('amountMax').value) || Infinity;
            const stockCode = document.getElementById('stockCode').value.trim();
             
             let filteredData = originalStockData.filter(stock => {
                 // ÈáèÊØîÁ≠õÈÄâ
                 const volumeRatio = stock.volume_ratio || 0;
                 if (volumeRatio < volumeRatioMin || volumeRatio > volumeRatioMax) {
                     return false;
                 }
                 
                 // Êç¢ÊâãÁéáÁ≠õÈÄâ
                 const turnoverRate = stock.turnover_rate || 0;
                 if (turnoverRate < turnoverRateMin || turnoverRate > turnoverRateMax) {
                     return false;
                 }
                 
                 // ÂáÄÊµÅÂÖ•È¢ùÁ≠õÈÄâÔºàÂ∑≤ÁªèÊòØ‰∏áÂÖÉÂçï‰ΩçÔºâ
                 const netMfAmount = stock.net_mf_amount ? (stock.net_mf_amount / 10000) : 0;
                 if (netMfAmount < netMfAmountMin || netMfAmount > netMfAmountMax) {
                     return false;
                 }
                 
                 // Êàê‰∫§È¢ùÁ≠õÈÄâÔºàËΩ¨Êç¢‰∏∫‰∫øÂÖÉÔºâ
                 const amount = stock.amount ? (stock.amount / 100000000) : 0;
                 if (amount < amountMin || amount > amountMax) {
                     return false;
                 }
                 
                 // ËÇ°Á•®‰ª£Á†ÅÁ≠õÈÄâ
                 if (stockCode && !stock.ts_code.includes(stockCode)) {
                     return false;
                 }
                
                return true;
            });
            
            // Â¶ÇÊûúÊúâÂΩìÂâçÊéíÂ∫èÔºåÂ∫îÁî®Âà∞Á≠õÈÄâÂêéÁöÑÊï∞ÊçÆ
            if (currentSortField) {
                filteredData.sort((a, b) => {
                    let valueA = a[currentSortField];
                    let valueB = b[currentSortField];
                    
                    // Â§ÑÁêÜnull/undefinedÂÄº
                    if (valueA == null && valueB == null) return 0;
                    if (valueA == null) return 1;
                    if (valueB == null) return -1;
                    
                    // Â≠óÁ¨¶‰∏≤Á±ªÂûãÊéíÂ∫è
                    if (typeof valueA === 'string' && typeof valueB === 'string') {
                        valueA = valueA.toLowerCase();
                        valueB = valueB.toLowerCase();
                        if (currentSortOrder === 'asc') {
                            return valueA.localeCompare(valueB);
                        } else {
                            return valueB.localeCompare(valueA);
                        }
                    }
                    
                    // Êï∞ÂÄºÁ±ªÂûãÊéíÂ∫è
                    if (currentSortOrder === 'asc') {
                        return valueA - valueB;
                    } else {
                        return valueB - valueA;
                    }
                });
            }
            
            displayStockData(filteredData);
            document.getElementById('totalCount').textContent = `ÂÖ± ${filteredData.length} Âè™ËÇ°Á•®`;
            
            if (filteredData.length === 0) {
                document.getElementById('stockTable').style.display = 'none';
                document.getElementById('noDataMessage').style.display = 'block';
            }
        }
        
        // Ê∏ÖÈô§Á≠õÈÄâÊù°‰ª∂
        function clearFilters() {
             document.getElementById('volumeRatioMin').value = '';
             document.getElementById('volumeRatioMax').value = '';
             document.getElementById('turnoverRateMin').value = '';
             document.getElementById('turnoverRateMax').value = '';
             document.getElementById('netMfAmountMin').value = '';
             document.getElementById('netMfAmountMax').value = '';
             document.getElementById('amountMin').value = '';
             document.getElementById('amountMax').value = '';
             document.getElementById('stockCode').value = '';
            
            // ÈáçÁΩÆÊéíÂ∫èÁä∂ÊÄÅ
            currentSortField = null;
            currentSortOrder = 'asc';
            updateSortIcons('', '');
            
            displayStockData(originalStockData);
            document.getElementById('totalCount').textContent = `ÂÖ± ${originalStockData.length} Âè™ËÇ°Á•®`;
        }
        
        // ÊéíÂ∫èÂäüËÉΩ
        function sortTable(field) {
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂêå‰∏Ä‰∏™Â≠óÊÆµÔºåÂàáÊç¢ÊéíÂ∫èÈ°∫Â∫è
            if (currentSortField === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortOrder = 'asc';
            }
            
            // Êõ¥Êñ∞ÊéíÂ∫èÂõæÊ†á
            updateSortIcons(field, currentSortOrder);
            
            // ÂØπÂΩìÂâçÊï∞ÊçÆËøõË°åÊéíÂ∫è
            const sortedData = [...currentStockData].sort((a, b) => {
                let valueA = a[field];
                let valueB = b[field];
                
                // Â§ÑÁêÜnull/undefinedÂÄº
                if (valueA == null && valueB == null) return 0;
                if (valueA == null) return 1;
                if (valueB == null) return -1;
                
                // Â≠óÁ¨¶‰∏≤Á±ªÂûãÊéíÂ∫è
                if (typeof valueA === 'string' && typeof valueB === 'string') {
                    valueA = valueA.toLowerCase();
                    valueB = valueB.toLowerCase();
                    if (currentSortOrder === 'asc') {
                        return valueA.localeCompare(valueB);
                    } else {
                        return valueB.localeCompare(valueA);
                    }
                }
                
                // Êï∞ÂÄºÁ±ªÂûãÊéíÂ∫è
                if (currentSortOrder === 'asc') {
                    return valueA - valueB;
                } else {
                    return valueB - valueA;
                }
            });
            
            // ÈáçÊñ∞Ê∏≤ÊüìË°®Ê†º
            displayStockData(sortedData);
        }
        
        // Â∫îÁî®Êàê‰∫§È¢ùÈó®Êßõ
        function applyAmountThreshold() {
            const selectedThreshold = document.querySelector('input[name="amountThreshold"]:checked').value;
            
            // Ê∏ÖÈô§Áé∞ÊúâÁöÑÊàê‰∫§È¢ùÁ≠õÈÄâÊù°‰ª∂
            document.getElementById('amountMin').value = '';
            document.getElementById('amountMax').value = '';
            
            // Ê†πÊçÆÈÄâÊã©ÁöÑÈó®ÊßõËÆæÁΩÆÊúÄÂ∞èÊàê‰∫§È¢ù
            if (selectedThreshold !== '0') {
                document.getElementById('amountMin').value = selectedThreshold;
            }
            
            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            loadLimitUpData();
        }
        
        // Êõ¥Êñ∞ÊéíÂ∫èÂõæÊ†á
        function updateSortIcons(activeField, order) {
            // ÈáçÁΩÆÊâÄÊúâÂõæÊ†á
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'fas fa-sort sort-icon';
            });
            
            // ËÆæÁΩÆÂΩìÂâçÊ¥ªÂä®Â≠óÊÆµÁöÑÂõæÊ†á
            const activeIcon = document.getElementById(`sort-${activeField}`);
            if (activeIcon) {
                if (order === 'asc') {
                    activeIcon.className = 'fas fa-sort-up sort-icon active';
                } else {
                    activeIcon.className = 'fas fa-sort-down sort-icon active';
                }
            }
        }
    </script>
</body>
</html>