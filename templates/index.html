<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票选股系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                股票选股系统
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-primary btn-sm me-2" onclick="syncAllAStockData()">
                    <i class="fas fa-sync-alt"></i> 同步A股数据
                </button>

                <button class="btn btn-outline-secondary btn-sm me-2" onclick="syncIndexDaily()">
                    <i class="fas fa-chart-bar"></i> 同步指数数据
                </button>
                <button class="btn btn-success btn-sm me-2" onclick="generateAnalysisData()">
                    <i class="fas fa-database"></i> 生成分析表
                </button>
                <button class="btn btn-warning btn-sm me-2" onclick="syncMoneyflowData()">
                    <i class="fas fa-money-bill-wave"></i> 同步资金流向
                </button>
                <button class="btn btn-info btn-sm me-2" onclick="syncTdSequential()">
                    <i class="fas fa-filter"></i> 同步九转序列
                </button>
                
                <!-- 系统资源显示 -->
                <div class="d-flex align-items-center text-light me-3">
                    <small id="systemResources" class="text-nowrap">
                        <i class="fas fa-microchip me-1"></i>
                        <span id="cpuUsage">CPU: -</span>
                        <span class="mx-2">|</span>
                        <i class="fas fa-memory me-1"></i>
                        <span id="memUsage">MEM: -</span>
                        <span class="mx-2">|</span>
                        <span id="memFree">FREE: -</span>
                    </small>
                </div>

            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 系统状态卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">股票总数</h6>
                                <h4 id="stockCount">-</h4>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-building fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">数据总量</h6>
                                <h4 id="totalRecords">-</h4>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-database fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">最新日期</h6>
                                <h6 id="latestDate">-</h6>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-calendar fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">系统状态</h6>
                                <h6 id="systemStatus">运行中</h6>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-heartbeat fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 筛选和搜索 -->
        <div class="card mb-4">
            
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-auto">
                        <label for="searchStock" class="form-label">股票代码</label>
                        <input type="text" class="form-control" id="searchStock" placeholder="6位代码" maxlength="6" pattern="[0-9]{6}" oninput="handleStockCodeInput(this)" style="width: 120px;">
                    </div>
                    <div class="col-auto">
                        <label for="sortBy" class="form-label">排序方式</label>
                        <select class="form-select" id="sortBy" style="width: 100px;">
                            <option value="pct_chg">涨跌幅</option>
                            <option value="vol">成交量</option>
                            <option value="amount">成交额</option>
                            <option value="close">收盘价</option>
                            <option value="ts_code">股票代码</option>
                            <option value="name">股票名称</option>
                            <option value="open">开盘价</option>
                            <option value="high">最高价</option>
                            <option value="low">最低价</option>
                            <option value="pre_close">昨收价</option>
                            <option value="change">涨跌额</option>
                            <option value="td_sequential">九转序列</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <label for="sortOrder" class="form-label">排序顺序</label>
                        <select class="form-select" id="sortOrder" style="width: 80px;">
                            <option value="desc">降序</option>
                            <option value="asc">升序</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <label for="tdSequentialFilter" class="form-label">九转序列</label>
                        <select class="form-select" id="tdSequentialFilter" style="width: 120px;">
                            <option value="">全部</option>
                            <option value="red">红色信号</option>
                            <option value="green">绿色信号</option>
                            <option value="high">高位(>7)</option>
                            <option value="low">低位(<-7)</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="applyFilter()">
                                <i class="fas fa-filter"></i> 筛选
                            </button>
                            <button class="btn btn-info" onclick="window.open('/td_sequential_result', '_blank')" title="九转序列筛选结果">
                                <i class="fas fa-chart-line"></i> 九转序列
                            </button>
                            <button class="btn btn-success" onclick="window.open('/favorites', '_blank')" title="自选股">
                                <i class="fas fa-star"></i> 自选股
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 指数行情卡片 -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">指数行情数据</h5>
                <div>
                    <span class="badge bg-secondary" id="indexDataCount">0</span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshIndexData()">
                        <i class="fas fa-refresh"></i> 刷新
                    </button>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-2">
                    <div class="card border-primary">
                        <div class="card-body text-center p-3">
                            <h6 class="card-title text-primary mb-2" id="index1Name">上证指数</h6>
                            <div class="mb-1">
                                <small class="text-muted">收盘价: </small><span class="fw-bold" id="index1Close">-</span>
                            </div>
                            <div class="mb-1">
                                <small class="text-muted">涨跌幅: </small><span class="fw-bold" id="index1PctChg">-</span>
                            </div>
                            <div>
                                <small class="text-muted">成交额: </small><span class="fw-bold" id="index1Amount">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card border-success">
                        <div class="card-body text-center p-3">
                            <h6 class="card-title text-success mb-2" id="index2Name">深证成指</h6>
                            <div class="mb-1">
                                <small class="text-muted">收盘价: </small><span class="fw-bold" id="index2Close">-</span>
                            </div>
                            <div class="mb-1">
                                <small class="text-muted">涨跌幅: </small><span class="fw-bold" id="index2PctChg">-</span>
                            </div>
                            <div>
                                <small class="text-muted">成交额: </small><span class="fw-bold" id="index2Amount">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card border-info">
                        <div class="card-body text-center p-3">
                            <h6 class="card-title text-info mb-2" id="index3Name">创业板指</h6>
                            <div class="mb-1">
                                <small class="text-muted">收盘价: </small><span class="fw-bold" id="index3Close">-</span>
                            </div>
                            <div class="mb-1">
                                <small class="text-muted">涨跌幅: </small><span class="fw-bold" id="index3PctChg">-</span>
                            </div>
                            <div>
                                <small class="text-muted">成交额: </small><span class="fw-bold" id="index3Amount">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card border-warning">
                        <div class="card-body text-center p-3">
                            <h6 class="card-title text-warning mb-2" id="index4Name">科创50</h6>
                            <div class="mb-1">
                                <small class="text-muted">收盘价: </small><span class="fw-bold" id="index4Close">-</span>
                            </div>
                            <div class="mb-1">
                                <small class="text-muted">涨跌幅: </small><span class="fw-bold" id="index4PctChg">-</span>
                            </div>
                            <div>
                                <small class="text-muted">成交额: </small><span class="fw-bold" id="index4Amount">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card border-danger">
                        <div class="card-body text-center p-3">
                            <h6 class="card-title text-danger mb-2" id="index5Name">中证500</h6>
                            <div class="mb-1">
                                <small class="text-muted">收盘价: </small><span class="fw-bold" id="index5Close">-</span>
                            </div>
                            <div class="mb-1">
                                <small class="text-muted">涨跌幅: </small><span class="fw-bold" id="index5PctChg">-</span>
                            </div>
                            <div>
                                <small class="text-muted">成交额: </small><span class="fw-bold" id="index5Amount">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card border-secondary">
                        <div class="card-body text-center p-3">
                            <h6 class="card-title text-secondary mb-2" id="index6Name">沪深300</h6>
                            <div class="mb-1">
                                <small class="text-muted">收盘价: </small><span class="fw-bold" id="index6Close">-</span>
                            </div>
                            <div class="mb-1">
                                <small class="text-muted">涨跌幅: </small><span class="fw-bold" id="index6PctChg">-</span>
                            </div>
                            <div>
                                <small class="text-muted">成交额: </small><span class="fw-bold" id="index6Amount">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 股票数据表格 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">股票行情数据</h5>
                <div>
                    <span class="badge bg-secondary" id="dataCount">0</span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshData()">
                        <i class="fas fa-refresh"></i> 刷新
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th class="sortable" data-field="ts_code">股票代码 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="name">股票名称 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="industry">行业 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="area">地域 <i class="fas fa-sort"></i></th>
                                <th style="display: none;">交易日期</th>
                                <th class="sortable" data-field="open">开盘价 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="high" style="display: none;">最高价 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="low" style="display: none;">最低价 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="close">收盘价 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="pre_close">昨收价 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="change" style="display: none;">涨跌额 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="pct_chg">涨跌幅 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="turnover_rate">换手率 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="volume_ratio">量比 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="pe">市盈率 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="pb">市净率 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="total_mv">总市值 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="net_mf_amount">净流入额 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="amount">成交额 <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-field="td_sequential">九转 <i class="fas fa-sort"></i></th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <tr>
                                <td colspan="12" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 股票详情模态框 -->
    <div class="modal fade" id="stockDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stockDetailTitle">股票详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="stockDetailContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">系统通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- 通知内容 -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        function syncTdSequential() {
            // 显示加载提示
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 筛选中...';
            button.disabled = true;

            fetch('/api/sync_td_sequential', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                // 恢复按钮状态
                button.innerHTML = originalText;
                button.disabled = false;

                if (data.success) {
                    alert(data.message);
                    // 在新标签页打开筛选结果页面
                    window.open('/td_sequential_result', '_blank');
                } else {
                    alert('筛选失败：' + data.message);
                }
            })
            .catch(error => {
                // 恢复按钮状态
                button.innerHTML = originalText;
                button.disabled = false;
                
                console.error('Error:', error);
                alert('筛选失败：' + error.message);
            });
        }

        function handleStockCodeInput(input) {
            // 只允许输入数字
            input.value = input.value.replace(/[^0-9]/g, '');
            
            // 当输入满6位数字时自动跳转
            if (input.value.length === 6) {
                const stockCode = input.value;
                // 根据股票代码判断市场后缀
                let fullCode;
                if (stockCode.startsWith('6')) {
                    fullCode = stockCode + '.SH'; // 上海市场
                } else if (stockCode.startsWith('0') || stockCode.startsWith('3')) {
                    fullCode = stockCode + '.SZ'; // 深圳市场
                } else {
                    // 其他情况默认上海市场
                    fullCode = stockCode + '.SH';
                }
                
                // 在新标签页打开股票详情页
                window.open(`/stock/${fullCode}`, '_blank');
                
                // 清空输入框
                setTimeout(() => {
                    input.value = '';
                }, 100);
            }
        }
        
        // 系统资源监控功能
        function updateSystemResources() {
            fetch('/api/system_resources')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('cpuUsage').textContent = `CPU: ${data.cpu_percent}%`;
                        document.getElementById('memUsage').textContent = `MEM: USED: ${data.memory_percent}%`;
                        document.getElementById('memFree').textContent = `FREE: ${data.memory_free_mb}M`;
                    } else {
                        document.getElementById('cpuUsage').textContent = 'CPU: -';
                        document.getElementById('memUsage').textContent = 'MEM: -';
                        document.getElementById('memFree').textContent = 'FREE: -';
                    }
                })
                .catch(error => {
                    console.error('获取系统资源失败:', error);
                    document.getElementById('cpuUsage').textContent = 'CPU: -';
                    document.getElementById('memUsage').textContent = 'MEM: -';
                    document.getElementById('memFree').textContent = 'FREE: -';
                });
        }
        
        // 页面加载完成后开始监控系统资源
        document.addEventListener('DOMContentLoaded', function() {
            // 立即获取一次系统资源信息
            updateSystemResources();
            
            // 每5秒更新一次系统资源信息
            setInterval(updateSystemResources, 5000);
        });


    </script>
</body>
</html>