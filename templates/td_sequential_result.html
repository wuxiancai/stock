<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>九转序列筛选结果 - 股票选股系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        body {
            font-size: 12px;
        }
        .table {
            font-size: 11px;
        }
        .table th {
            font-size: 11px;
            font-weight: 600;
        }
        .table td {
            font-size: 11px;
        }
        .td-positive {
            color: #dc3545;
            font-weight: bold;
        }
        .td-negative {
            color: #28a745;
            font-weight: bold;
        }
        .stock-row:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-item label {
            font-weight: 500;
            margin: 0;
            white-space: nowrap;
        }
        .filter-item input {
            width: 80px;
            font-size: 11px;
        }
        .filter-item select {
            width: 100px;
            font-size: 11px;
        }
        .hidden-column {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>
                股票选股系统
            </a>
            <div class="navbar-nav ms-auto">
                <a class="btn btn-outline-light btn-sm" href="/">
                    <i class="fas fa-home"></i> 返回首页
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-filter me-2"></i>
                            九转序列筛选结果（红2以上）
                        </h5>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> 刷新数据
                            </button>
                            <span class="badge bg-info ms-2" id="totalCount">加载中...</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 筛选条件区域 -->
                        <div class="filter-section">
                            <div class="filter-row">
                                <div class="filter-item">
                                    <label>量比:</label>
                                    <input type="number" id="volumeRatioMin" class="form-control" placeholder="最小值" step="0.1">
                                    <span>-</span>
                                    <input type="number" id="volumeRatioMax" class="form-control" placeholder="最大值" step="0.1">
                                </div>
                                <div class="filter-item">
                                    <label>换手率(%):</label>
                                    <input type="number" id="turnoverRateMin" class="form-control" placeholder="最小值" step="0.1">
                                    <span>-</span>
                                    <input type="number" id="turnoverRateMax" class="form-control" placeholder="最大值" step="0.1">
                                </div>
                                <div class="filter-item">
                                    <label>净流入额(万):</label>
                                    <input type="number" id="netMfAmountMin" class="form-control" placeholder="最小值">
                                    <span>-</span>
                                    <input type="number" id="netMfAmountMax" class="form-control" placeholder="最大值">
                                </div>
                                <div class="filter-item">
                                    <label>九转序列:</label>
                                    <input type="number" id="tdSequentialMin" class="form-control" placeholder="最小值" step="1">
                                    <span>-</span>
                                    <input type="number" id="tdSequentialMax" class="form-control" placeholder="最大值" step="1">
                                </div>
                                <div class="filter-item">
                                    <label>股票代码:</label>
                                    <input type="text" id="stockCode" class="form-control" placeholder="如:300222" style="width: 120px;">
                                </div>
                                <div class="filter-item">
                                    <button class="btn btn-primary btn-sm" onclick="applyFilters()">
                                        <i class="fas fa-filter"></i> 应用筛选
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="clearFilters()">
                                        <i class="fas fa-times"></i> 清除
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="loadingIndicator" class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">正在加载九转序列数据...</p>
                        </div>
                        
                        <div id="stockTable" class="table-responsive" style="display: none;">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>股票代码</th>
                                        <th>股票名称</th>
                                        <th>行业</th>
                                        <th>地域</th>
                                        <th>九转序列</th>
                                        <th>最新价</th>
                                        <th>涨跌幅</th>
                                        <th class="hidden-column">涨跌额</th>
                                        <th>换手率</th>
                                        <th>量比</th>
                                        <th>市盈率</th>
                                        <th>市净率</th>
                                        <th>总市值</th>
                                        <th>净流入额</th>
                                        <th class="hidden-column">成交量(万手)</th>
                                        <th>成交额</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="stockTableBody">
                                    <!-- 数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="noDataMessage" class="text-center py-4" style="display: none;">
                            <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">暂无符合条件的股票</h5>
                            <p class="text-muted">当前没有找到九转数值大于红2的股票</p>
                        </div>
                        
                        <div id="errorMessage" class="alert alert-danger" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="errorText"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">系统通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- 通知内容 -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量存储原始数据
        let originalStockData = [];
        
        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', function() {
            loadTdSequentialData();
        });

        function loadTdSequentialData() {
            // 显示加载指示器
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('stockTable').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            fetch('/api/td_sequential_stocks')
                .then(response => response.json())
                .then(data => {
                    // 隐藏加载指示器
                    document.getElementById('loadingIndicator').style.display = 'none';

                    if (data.stocks && data.stocks.length > 0) {
                        originalStockData = data.stocks; // 保存原始数据
                        displayStockData(data.stocks);
                        document.getElementById('totalCount').textContent = `共 ${data.total} 只股票`;
                    } else {
                        document.getElementById('noDataMessage').style.display = 'block';
                        document.getElementById('totalCount').textContent = '0 只股票';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('errorText').textContent = '加载数据失败：' + error.message;
                    document.getElementById('totalCount').textContent = '加载失败';
                });
        }

        function displayStockData(stocks) {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';

            stocks.forEach(stock => {
                const row = document.createElement('tr');
                row.className = 'stock-row';
                row.onclick = () => viewStockDetail(stock.ts_code);

                // 格式化九转序列显示
                let tdSequentialDisplay = '';
                if (stock.td_sequential > 0) {
                    tdSequentialDisplay = `<span class="td-positive">红${stock.td_sequential}</span>`;
                } else if (stock.td_sequential < 0) {
                    tdSequentialDisplay = `<span class="td-negative">绿${Math.abs(stock.td_sequential)}</span>`;
                } else {
                    tdSequentialDisplay = '-';
                }

                // 格式化涨跌幅颜色
                let pctChgClass = '';
                if (stock.pct_chg > 0) {
                    pctChgClass = 'text-danger';
                } else if (stock.pct_chg < 0) {
                    pctChgClass = 'text-success';
                }

                row.innerHTML = `
                    <td><strong>${stock.ts_code}</strong></td>
                    <td>${stock.name || '-'}</td>
                    <td>${stock.industry || '-'}</td>
                    <td>${stock.area || '-'}</td>
                    <td>${tdSequentialDisplay}</td>
                    <td>¥${stock.close.toFixed(2)}</td>
                    <td class="${pctChgClass}">${stock.pct_chg > 0 ? '+' : ''}${stock.pct_chg.toFixed(2)}%</td>
                    <td class="hidden-column ${pctChgClass}">${stock.change > 0 ? '+' : ''}${stock.change.toFixed(2)}</td>
                    <td>${stock.turnover_rate ? stock.turnover_rate.toFixed(2) + '%' : '-'}</td>
                    <td>${stock.volume_ratio ? stock.volume_ratio.toFixed(2) : '-'}</td>
                    <td>${stock.pe ? stock.pe.toFixed(2) : '-'}</td>
                    <td>${stock.pb ? stock.pb.toFixed(2) : '-'}</td>
                    <td>${stock.total_mv ? (() => {
                        const value = stock.total_mv / 8391;
                        return value >= 1 ? value.toFixed(1) + '亿' : (value * 10000).toFixed(0) + '万';
                    })() : '-'}</td>
                    <td>${stock.net_mf_amount ? (() => {
                        const value = stock.net_mf_amount / 10000;
                        return value >= 1 ? value.toFixed(2) + '亿' : (value * 10000).toFixed(0) + '万';
                    })() : '-'}</td>
                    <td class="hidden-column">${(stock.vol / 10000).toFixed(2)}</td>
                    <td>${(() => {
                        const value = stock.amount / 100000;
                        return value >= 1 ? value.toFixed(1) + '亿' : (value * 10000).toFixed(0) + '万';
                    })()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewStockDetail('${stock.ts_code}')">
                            <i class="fas fa-chart-line"></i> 详情
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });

            document.getElementById('stockTable').style.display = 'block';
        }

        function viewStockDetail(tsCode) {
            // 在新标签页打开股票详情页
            window.open(`/stock/${tsCode}`, '_blank');
        }

        function refreshData() {
            loadTdSequentialData();
            showToast('数据刷新中...', 'info');
        }

        function showToast(message, type = 'info') {
            const toastElement = document.getElementById('notificationToast');
            const toastBody = document.getElementById('toastMessage');
            
            toastBody.textContent = message;
            
            // 设置Toast样式
            toastElement.className = `toast ${type === 'success' ? 'bg-success text-white' : type === 'error' ? 'bg-danger text-white' : ''}`;
            
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }
        
        // 应用筛选条件
        function applyFilters() {
            const volumeRatioMin = parseFloat(document.getElementById('volumeRatioMin').value) || 0;
            const volumeRatioMax = parseFloat(document.getElementById('volumeRatioMax').value) || Infinity;
            const turnoverRateMin = parseFloat(document.getElementById('turnoverRateMin').value) || 0;
            const turnoverRateMax = parseFloat(document.getElementById('turnoverRateMax').value) || Infinity;
            const netMfAmountMin = parseFloat(document.getElementById('netMfAmountMin').value) || -Infinity;
            const netMfAmountMax = parseFloat(document.getElementById('netMfAmountMax').value) || Infinity;
            const tdSequentialMin = parseFloat(document.getElementById('tdSequentialMin').value) || -Infinity;
             const tdSequentialMax = parseFloat(document.getElementById('tdSequentialMax').value) || Infinity;
             const stockCode = document.getElementById('stockCode').value.trim();
             
             let filteredData = originalStockData.filter(stock => {
                 // 量比筛选
                 const volumeRatio = stock.volume_ratio || 0;
                 if (volumeRatio < volumeRatioMin || volumeRatio > volumeRatioMax) {
                     return false;
                 }
                 
                 // 换手率筛选
                 const turnoverRate = stock.turnover_rate || 0;
                 if (turnoverRate < turnoverRateMin || turnoverRate > turnoverRateMax) {
                     return false;
                 }
                 
                 // 净流入额筛选（已经是万元单位）
                 const netMfAmount = stock.net_mf_amount ? (stock.net_mf_amount / 10000) : 0;
                 if (netMfAmount < netMfAmountMin || netMfAmount > netMfAmountMax) {
                     return false;
                 }
                 
                 // 九转序列筛选
                 const tdSequential = stock.td_sequential || 0;
                 if (tdSequential < tdSequentialMin || tdSequential > tdSequentialMax) {
                     return false;
                 }
                 
                 // 股票代码筛选
                 if (stockCode && !stock.ts_code.includes(stockCode)) {
                     return false;
                 }
                
                return true;
            });
            
            displayStockData(filteredData);
            document.getElementById('totalCount').textContent = `共 ${filteredData.length} 只股票`;
            
            if (filteredData.length === 0) {
                document.getElementById('stockTable').style.display = 'none';
                document.getElementById('noDataMessage').style.display = 'block';
            }
        }
        
        // 清除筛选条件
        function clearFilters() {
             document.getElementById('volumeRatioMin').value = '';
             document.getElementById('volumeRatioMax').value = '';
             document.getElementById('turnoverRateMin').value = '';
             document.getElementById('turnoverRateMax').value = '';
             document.getElementById('netMfAmountMin').value = '';
             document.getElementById('netMfAmountMax').value = '';
             document.getElementById('tdSequentialMin').value = '';
             document.getElementById('tdSequentialMax').value = '';
             document.getElementById('stockCode').value = '';
            
            displayStockData(originalStockData);
            document.getElementById('totalCount').textContent = `共 ${originalStockData.length} 只股票`;
        }
    </script>
</body>
</html>